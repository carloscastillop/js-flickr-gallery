/** 
 * @projectDescription JsFlickrGallery - Simple JavaScript Flickr gallery, http://petejank.github.io/js-flickr-gallery/
 * 
 * @version 1.0.0
 * @author   Peter Jankowski http://likeadev.com
 * @license  MIT license.
 */
(function(c,f,g,a){var d="json",j="flickr.photos.search",i="62525ee8c8d131d708d33d61f29434b6";var e="jsFlickrGallery",b={fetchImages:true,animation:"fade",animationSpeed:250,preload:{range:2},structure:{ulClass:"thumbnails",liClass:"span1",aClass:"thumbnail"},modal:{generate:true,id:"jsfg-modal",title:".modal-header h3",imageContainer:".modal-body .modal-image",onContainerNext:true,imageFadeTime:250,prev:".modal-prev",next:".modal-next",prevText:"Previous image",nextText:"Next image",offsetWidth:100,offsetHeight:200},pagination:{generate:true,containerClass:"pagination",prev:".pagination-prev",next:".pagination-next",prevText:"Previous page",nextText:"Next page"},loader:{animation:true,text:"Loading",interval:200,mark:".",maxMarks:3},url:{per_page:30,tagmode:"all",user_id:null,tags:null},error:{text:"No photos found",tagClass:"error"},imageSizes:{small:"s",medium_100:"t",medium:"q",medium_640:"z",large:"b",original:"o"},apiUrl:"http://api.flickr.com/services/rest/?jsoncallback=?",setDefaultSize:function(){this.thumbnailSize=this.imageSizes.medium;this.imageSize=this.imageSizes.large}};function h(l,k){this.element=l;this.$element=c(l);this.options=c.extend(true,{},b,k);this.paginationContext=this.options.pagination&&this.options.pagination.generate?this.element:g;if(!this.options.thumbnailSize&&!this.options.imageSize){this.options.setDefaultSize()}this.anchors="ul"+(this.options.structure.ulClass?"."+this.options.structure.ulClass:null)+" li a"+(this.options.structure.aClass?"."+this.options.structure.aClass:null);this.galleryId=this.element.id||Math.random().toString(36);this.page=1;this.init()}h.prototype={init:function(){if(this.options.fetchImages){if(this.options.loader){this.loaderInterval=this._createLoader(this.$element)}this.createGallery()}else{this.$anchors=c(this.anchors,this.$element)}if(this.options.pagination&&this.options.fetchImages){if(this.options.pagination.generate){this._createPagination()}this._bindPaginationEvents()}if(this.options.modal){if(this.options.modal.generate){this._createModal()}this._bindModalEvents()}},createGallery:function(k){this.options.url.format=d;this.options.url.method=j;this.options.url.api_key=i;this.options.url.page=this.page=k||this.page;this.options.url.tags=this.$element.attr("data-tags")||this.options.url.tags;this.options.url.user_id=this.$element.attr("data-user-id")||this.options.url.user_id;if(!this.options.url.user_id){delete this.options.url.user_id}this.options.url.per_page=this.$element.attr("data-per-page")||this.options.url.per_page;this._getPhotos();return this},clearGallery:function(){var k=c("ul."+this.options.structure.ulClass,this.$element),m=this;switch(this.options.animation){case"fade":k.fadeOut(this.options.animationSpeed,function(){l()});break;case"show":k.hide(this.options.animationSpeed,function(){l()});break;case false:k.hide(0,function(){l()})}function l(){if(m.options.loader){m.loaderInterval=m._createLoader(m.$element)}k.remove()}return this},isLastPage:function(){return this.$element.children("ul").find("li").length<this.options.url.per_page},nextPage:function(){if(!this.isLastPage()){return this.clearGallery().createGallery(this.page+1)}else{return false}},prevPage:function(){if(this.page>1){return this.clearGallery().createGallery(this.page-1)}else{return false}},prevImage:function(){this.index-=1;if(this.index<0){this.index=this.$anchors.length-1}return this._loadImage(false)},nextImage:function(){this.index+=1;if(this.index>this.$anchors.length-1){this.index=0}return this._loadImage(false)},_getPhotos:function(){var k=this;c.ajax({type:"GET",url:k.options.apiUrl,data:k.options.url,dataType:"jsonp",timeout:10000}).done(function(l){k._renderGalleryContent(l.photos)}).always(function(l,m){if(m==="timeout"){k._getPhotos()}})},_renderGalleryContent:function(s){var o=this,k,n,l="",p=0,q,r;if(s.photo.length>0){n=c("<ul "+(o.options.structure.ulClass?'class="'+o.options.structure.ulClass+'"':null)+' style="display: none">');for(var m=0;m<s.photo.length;m++){q="http://farm"+s.photo[m].farm+".static.flickr.com/"+s.photo[m].server+"/"+s.photo[m].id+"_"+s.photo[m].secret+"_";r=this._htmlEscape(s.photo[m].title);l+="<li "+(o.options.structure.liClass?'class="'+o.options.structure.liClass+'"':null)+'><a href="'+q+o.options.imageSize+'.jpg" title="'+r+'"'+(o.options.structure.aClass?'class="'+o.options.structure.aClass+'"':null)+'  target="_blank"><img alt="'+r+'" src="'+q+o.options.thumbnailSize+'.jpg"/></a></li>'}o.$element.prepend(n.append(l));k=n.find("img");k.on("error",function(){var t=c(this),u=t.prop("src");t.prop("src",null).prop("src",u)});k.on("load",function(){p++;if(p===s.photo.length){o._removeLoader(o.$element);switch(o.options.animation){case"fade":n.fadeIn(o.options.animationSpeed);break;case"show":n.show(o.options.animationSpeed);break;case false:n.show()}k.off("load").off("error");o.$anchors=c(o.anchors,o.$element);o._togglePagination()}})}else{o.$element.prepend('<span class="'+o.options.error.tagClass+'">'+o.options.error.text+"</span>");o._removeLoader(o.$element)._togglePagination()}return o},_htmlEscape:function(k){return k.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},_createPagination:function(){var l="",m=c(this.options.pagination.prev,this.paginationContext),k=c(this.options.pagination.next,this.paginationContext);if(m.length===0&&k.length===0&&this.options.pagination.generate){l+='<div class="'+this.options.pagination.containerClass+'"><button class="btn'+this.options.pagination.prev.replace(/\./g," ")+'" title="'+this.options.pagination.prevText+'" '+(this.page===1?'disabled="disabled" ':null)+' >&laquo;</button><button class="btn'+this.options.pagination.next.replace(/\./g," ")+'" title="'+this.options.pagination.nextText+'" '+(this.isLastPage()?' disabled="disabled" ':null)+">&raquo;</button></div>";this.$element.append(l)}return this},_bindPaginationEvents:function(){var m=this,l=c(this.options.pagination.prev,this.paginationContext),k=c(this.options.pagination.next,this.paginationContext);l.click(function(){if(!l.is(":disabled")){k.attr("disabled","disabled");l.attr("disabled","disabled");m.prevPage()}});k.click(function(){if(!k.is(":disabled")){l.attr("disabled","disabled");k.attr("disabled","disabled");m.nextPage()}})},_togglePagination:function(){if(this.page!==1){c(this.options.pagination.prev,this.paginationContext).removeAttr("disabled")}else{c(this.options.pagination.prev,this.paginationContext).attr("disabled","disabled")}if(!this.isLastPage()){c(this.options.pagination.next,this.paginationContext).removeAttr("disabled")}else{c(this.options.pagination.next,this.paginationContext).attr("disabled","disabled")}return this},_createModal:function(){var m,k,l;if(c("#"+this.options.modal.id).length===0){m='<div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h3></h3></div>',k='<div class="modal-body"><div class="modal-image"></div></div>',l='<div class="modal-footer"><button title="'+this.options.modal.prevText+'" class="btn'+this.options.modal.prev.replace(/\./g," ")+'">&laquo;</button><button title="'+this.options.modal.nextText+'" class="btn btn-primary'+this.options.modal.next.replace(/\./g," ")+'">&raquo;</button></div>';c("body").append('<div id="'+this.options.modal.id+'" class="modal jsfg-modal hide fade">'+m+k+l+"</div>")}return this},_bindModalEvents:function(){var n=this,m=this.options.modal.onContainerNext?this.options.modal.next+", "+this.options.modal.imageContainer:this.options.modal.next,k,l="#"+this.options.modal.id;this.$element.on("click",this.anchors,function(o){o.preventDefault();c("#"+n.options.modal.id).attr("data-gallery-id",n.galleryId);n.index=n.$anchors.find("img").index(c(this).find("img"));n._loadImage(true)});k=c("#"+n.options.modal.id);c(m,l).click(function(o){o.preventDefault();if(k.attr("data-gallery-id")===n.galleryId){n.nextImage()}});c(this.options.modal.prev,l).click(function(o){o.preventDefault();if(k.attr("data-gallery-id")===n.galleryId){n.prevImage()}});return this},_loadImage:function(p){var o=this,r=c("#"+this.options.modal.id),q=c(this.options.modal.title,r),k=o.index,s=c(this.$anchors[this.index]),m=c('<img style="display: none" alt="'+s.attr("title")+'" src="'+s.attr("href")+'"/>'),n=c(this.options.modal.imageContainer,r),l=c(f);n.children().hide();if(!m[0].complete){this.loaderInterval=this._createLoader(n)}q.text(s.attr("title"));if(p){r.modal("show")}m.on("error",function(){m.prop("src",null).prop("src",s.attr("href"))});m.on("load",function(){if(o.index===k){n.children().remove();o._removeLoader(n);m=o._resizeToFit(m,l);q.width(m[0].width);n.height(m[0].height).width(m[0].width);m.appendTo(o.options.modal.imageContainer);if(l.width()>767){r.css("top","");(c.support.transition?r.animate:r.css).call(r.stop(),{"margin-left":-r.outerWidth()/2,"margin-top":-r.outerHeight()/2})}else{r.css({top:(l.height()-r.outerHeight())/2,"margin-left":"","margin-top":""})}m.fadeIn(o.options.modal.imageFadeTime);if(o.options.preload){o._preloadImages()}}m.off("load").off("error")});return this},_preloadImages:function(){var n=this.index+this.options.preload.range+1,l=this.index-this.options.preload.range,k,m;for(m=l;m<n;m++){k=this.$anchors[m];if(k&&m!==this.index){c(g.createElement("img")).prop("src",k.href||c(k).attr("href"))}}return this},_resizeToFit:function(l,k){var o=1,n,m;n=k.width()-this.options.modal.offsetWidth;m=k.height()-this.options.modal.offsetHeight;if(l[0].width>n||l[0].height>m){o=Math.min(n/l[0].width,m/l[0].height)}l[0].width*=o;l[0].height*=o;return l},_createLoader:function(k){var m=c('<span class="animation-marks"></span>'),l=this.options;k.prepend(c('<p class="jsfg-loader">'+l.loader.text+"</span>").append(m));if(l.loader.animation){return setInterval(function(){if(m.text().length<=l.loader.maxMarks){m.append(l.loader.mark)}else{m.text("")}},l.loader.interval)}else{return true}},_removeLoader:function(k){if(this.loaderInterval){k.children(".jsfg-loader").remove();clearInterval(this.loaderInterval)}return this}};c.fn[e]=function(k){return this.each(function(){if(!c.data(this,"plugin_"+e)){c.data(this,"plugin_"+e,new h(this,k))}})};c(function(){c('[data-toggle="jsfg"]').jsFlickrGallery()})})(jQuery,window,document);