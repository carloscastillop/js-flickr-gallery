/** 
 * @projectDescription JsFlickrGallery - Simple JavaScript Flickr gallery, 
 * http://petejank.github.io/js-flickr-gallery/
 * 
 * @version 1.1
 * @author   Peter Jankowski http://likeadev.com
 * @license  MIT license.
 */
;(function(f,j,q,h){var v="json",p="flickr.photos.search",t="62525ee8c8d131d708d33d61f29434b6",k="data-tags",e="data-user-id",i="data-per-page",c="data-gallery-id",g="jsfg",s=767,u=10000,n="modal-header",r="h3",d="modal-body",m="modal-image",o="modal-footer";var a="jsFlickrGallery",l={fetchImages:true,animation:"fade",animationSpeed:250,preload:{range:2},structure:{ulClass:"thumbnails",liClass:"span1",aClass:"thumbnail"},modal:{generate:true,id:"jsfg-modal",title:"."+n+" "+r,imageContainerClass:"."+m,onContainerNext:true,imageFadeTime:250,prevClass:".btn.modal-prev",nextClass:".btn.modal-next",prevText:"Previous image",nextText:"Next image",offsetWidth:100,offsetHeight:200},pagination:{generate:true,containerClass:".pagination",prevClass:".btn.pagination-prev",nextClass:".btn.pagination-next",prevText:"Previous page",nextText:"Next page"},loader:{animation:true,loaderClass:".jsfg-loader",text:"Loading",interval:200,mark:".",markClass:".animation-marks",maxMarks:3},url:{per_page:30,tagmode:"all",user_id:null,tags:null},error:{text:"No photos found",tagClass:"error"},imageSizes:{small:"s",medium_100:"t",medium:"q",medium_640:"z",large:"b",original:"o"},apiUrl:"http://api.flickr.com/services/rest/?jsoncallback=?",setDefaultSize:function(){this.thumbnailSize=this.imageSizes.medium;this.imageSize=this.imageSizes.large}};function b(x,w){this.element=x;this.$element=f(x);this.options=f.extend(true,{},l,w);this.paginationContext=this.options.pagination&&this.options.pagination.generate?this.element:q;if(!this.options.thumbnailSize&&!this.options.imageSize){this.options.setDefaultSize()}this.galleryId=this.element.id||Math.random().toString(36);this.page=1;this.init()}b.prototype={init:function(){if(this.options.fetchImages){if(this.options.loader){this.loaderInterval=this._createLoader(this.element)}this.createGallery()}else{this.anchors=this._getAnchors()}if(this.options.pagination&&this.options.fetchImages){if(this.options.pagination.generate){this._createPagination()}this._bindPaginationEvents()}if(this.options.modal){if(this.options.modal.generate){this._createModal()}this._bindModalEvents()}},createGallery:function(w){this.options.url.format=v;this.options.url.method=p;this.options.url.api_key=t;this.options.url.page=this.page=w||this.page;this.options.url.tags=this.$element.attr(k)||this.options.url.tags;this.options.url.user_id=this.$element.attr(e)||this.options.url.user_id;if(!this.options.url.user_id){delete this.options.url.user_id}this.options.url.per_page=this.$element.attr(i)||this.options.url.per_page;this._getPhotos();return this},clearGallery:function(){var w=this.element.getElementsByClassName(this._replaceDots(this.options.structure.ulClass)).item(0),y=f(w),x=this;switch(this.options.animation){case"fade":y.fadeOut(this.options.animationSpeed,z);break;case"show":y.hide(this.options.animationSpeed,z);break;case false:y.hide(0,z)}function z(){if(x.options.loader){x.loaderInterval=x._createLoader(x.element)}w.parentNode.removeChild(w)}return this},isLastPage:function(){var w=this.element.getElementsByTagName("ul");if(w.length!==0){if(w.item(0).getElementsByTagName("li").length<this.options.url.per_page){return true}}return false},nextPage:function(){if(!this.isLastPage()){return this.clearGallery().createGallery(this.page+1)}else{return false}},prevPage:function(){if(this.page>1){return this.clearGallery().createGallery(this.page-1)}else{return false}},prevImage:function(){this.index-=1;if(this.index<0){this.index=this.anchors.length-1}return this._loadImage(false)},nextImage:function(){this.index+=1;if(this.index>this.anchors.length-1){this.index=0}return this._loadImage(false)},_getPhotos:function(){var w=this;f.ajax({type:"GET",url:w.options.apiUrl,data:w.options.url,dataType:"jsonp",timeout:u}).done(function(x){w._renderGalleryContent(x.photos)}).always(function(x,y){if(y==="timeout"){w._getPhotos()}})},_renderGalleryContent:function(E){var F=this,w,z,x="",A=0,C,D,B;if(E.photo.length>0){z=f("<ul "+(F.options.structure.ulClass?'class="'+F.options.structure.ulClass+'"':null)+' style="display: none">');for(var y=0;y<E.photo.length;y++){C="http://farm"+E.photo[y].farm+".static.flickr.com/"+E.photo[y].server+"/"+E.photo[y].id+"_"+E.photo[y].secret+"_";D=this._htmlEscape(E.photo[y].title);x+="<li "+(F.options.structure.liClass?'class="'+F.options.structure.liClass+'"':null)+'><a href="'+C+F.options.imageSize+'.jpg" title="'+D+'"'+(F.options.structure.aClass?'class="'+F.options.structure.aClass+'"':null)+' target="_blank"><img alt="'+D+'" src="'+C+F.options.thumbnailSize+'.jpg"/></a></li>'}F.element.insertBefore(z.append(x)[0],F.element.firstChild);w=z.find("img");w.on("error",function(){var G=f(this),H=G.attr("src");G.attr("src",null).attr("src",H)});w.on("load",function(){A++;if(A===E.photo.length){F._removeLoader(F.element);switch(F.options.animation){case"fade":z.fadeIn(F.options.animationSpeed);break;case"show":z.show(F.options.animationSpeed);break;case false:z.show()}w.off("load").off("error");F.anchors=F._getAnchors();F._togglePagination()}})}else{B=q.createElement("span");B.className=F.options.error.tagClass;B.innerHTML=F.options.error.text;F.element.insertBefore(B,F.element.firstChild);F._removeLoader(F.element)._togglePagination()}return F},_createPagination:function(){var w="",y=this.paginationContext.getElementsByClassName(this.options.pagination.prevClass),x=this.paginationContext.getElementsByClassName(this.options.pagination.nextClass);if(y.length===0&&x.length===0&&this.options.pagination.generate){w+='<div class="'+this._replaceDots(this.options.pagination.containerClass)+'"><button class="'+this._replaceDots(this.options.pagination.prevClass)+'" title="'+this.options.pagination.prevText+'" disabled="disabled">&laquo;</button><button class="'+this._replaceDots(this.options.pagination.nextClass)+'" title="'+this.options.pagination.nextText+'" disabled="disabled">&raquo;</button></div>';this.$element.append(w)}return this},_bindPaginationEvents:function(){var y=this,x=f(this.options.pagination.prevClass,this.paginationContext),w=f(this.options.pagination.nextClass,this.paginationContext);x.click(function(){if(!x.is(":disabled")){w.attr("disabled","disabled");x.attr("disabled","disabled");y.prevPage()}});w.click(function(){if(!w.is(":disabled")){x.attr("disabled","disabled");w.attr("disabled","disabled");y.nextPage()}})},_togglePagination:function(){var x=f(this.options.pagination.prevClass,this.paginationContext),w=f(this.options.pagination.nextClass,this.paginationContext);if(this.page!==1){x.removeAttr("disabled")}else{x.attr("disabled","disabled")}if(!this.isLastPage()){w.removeAttr("disabled")}else{w.attr("disabled","disabled")}return this},_createModal:function(){var z,w,y,x;if(!q.getElementById(this.options.modal.id)){z='<div class="'+n+'"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><'+r+"></"+r+"></div>";w='<div class="'+d+'"><div class="'+m+'"></div></div>';y='<div class="'+o+'"><button title="'+this.options.modal.prevText+'" class="'+this._replaceDots(this.options.modal.prevClass)+'">&laquo;</button><button title="'+this.options.modal.nextText+'" class="'+this._replaceDots(this.options.modal.nextClass)+'">&raquo;</button></div>';x=q.createElement("div");x.id=this.options.modal.id;x.className="modal jsfg-modal hide fade";x.innerHTML=z+w+y;q.body.appendChild(x)}return this},_bindModalEvents:function(){var w=this,z=this.options.modal.onContainerNext?this.options.modal.nextClass+", "+this.options.modal.imageContainerClass:this.options.modal.nextClass,x=f("#"+w.options.modal.id),y="#"+this.options.modal.id;this.$element.on("click","a."+this.options.structure.aClass,function(B){var A;B.preventDefault();x.attr(c,w.galleryId);for(A=0;A<w.anchors.length;A++){if(w.anchors.item(A)===this){w.index=A}}w._loadImage(true)});f(z,y).click(function(A){A.preventDefault();if(x.attr(c)===w.galleryId){w.nextImage()}});f(this.options.modal.prevClass,y).click(function(A){A.preventDefault();if(x.attr(c)===w.galleryId){w.prevImage()}});return this},_loadImage:function(A){var E=this,C=f("#"+this.options.modal.id),B=f(this.options.modal.title,C),w=E.index,D=f(this.anchors.item(this.index)),y=f("<img/>"),z=f(this.options.modal.imageContainerClass,C),x=f(j);z.children().hide();B.text(D.attr("title"));if(A){C.modal("show")}y.on("error",function(){y.prop("src",null).prop("src",D.attr("href"))});y.on("load",function(){if(E.index===w){z.children().remove();E._removeLoader(z[0]);y=E._resizeToFit(y,x);B.width(y.prop("width"));z.height(y.prop("height")).width(y.prop("width"));y.appendTo(z);if(x.width()>s){C.css("top","");(f.support.transition?C.animate:C.css).call(C.stop(),{"margin-left":-C.outerWidth()/2,"margin-top":-C.outerHeight()/2})}else{C.css({top:(x.height()-C.outerHeight())/2,"margin-left":"","margin-top":""})}y.fadeIn(E.options.modal.imageFadeTime);if(E.options.preload){E._preloadImages()}}y.off("load").off("error")});y.prop("src",D.attr("href")).attr("alt",D.attr("title"));if(!y[0].complete){this.loaderInterval=this._createLoader(z[0])}return this},_preloadImages:function(){var z=this.index+this.options.preload.range+1,x=this.index-this.options.preload.range,w,y,A;z=z>this.anchors.length?z-this.anchors.length:z;x=x>z?x-this.anchors.length:x;for(y=x;y<z;y++){A=y<0?this.anchors.length+y:y;w=this.anchors.item(A);if(w&&A!==this.index){f(q.createElement("img")).attr("src",w.href||f(w).attr("href"))}}return this},_resizeToFit:function(z,x){var C=1,B,A,y=z.prop("width"),w=z.prop("height");B=x.width()-this.options.modal.offsetWidth;A=x.height()-this.options.modal.offsetHeight;if(y>B||w>A){C=Math.min(B/y,A/w)}z.prop("width",y*C).prop("height",w*C);return z},_createLoader:function(y){var x=q.createElement("span"),z=q.createElement("p"),w=this.options;z.appendChild(q.createTextNode(w.loader.text));z.className=this._replaceDots(w.loader.loaderClass);x.className=this._replaceDots(w.loader.markClass);y.insertBefore(z.appendChild(x).parentNode,y.firstChild);if(w.loader.animation){return setInterval(function(){if(x.innerHTML.length<=w.loader.maxMarks){x.innerHTML+=w.loader.mark}else{x.innerHTML=""}},w.loader.interval)}else{return true}},_getAnchors:function(){return this.element.getElementsByClassName(this.options.structure.aClass)},_removeLoader:function(x){var w=x.getElementsByClassName(this._replaceDots(this.options.loader.loaderClass));if(this.loaderInterval&&w.length!==0){x.removeChild(w.item(0));clearInterval(this.loaderInterval)}return this},_htmlEscape:function(w){return w.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},_replaceDots:function(w){return w.replace(/\./g," ")}};f.fn[a]=function(w){return this.each(function(){if(!f.data(this,"plugin_"+a)){f.data(this,"plugin_"+a,new b(this,w))}})};f(function(){f('[data-toggle="'+g+'"]').jsFlickrGallery()})})(jQuery,window,document);